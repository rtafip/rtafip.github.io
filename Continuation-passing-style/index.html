<!DOCTYPE html><html lang="en-US"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Continuation-passing style · 拖鞋党的拖鞋摊</title><meta name="description" content="Continuation-passing style - 拖鞋党"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://en.ors-sro.com/atom.xml" title="拖鞋党的拖鞋摊"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/icon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/rss/" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Continuation-passing style</h1><div class="post-info">Jan 1, 2017</div><div class="post-content"><p>我把未来抛给了你。</p>
<a id="more"></a>
<h2 id="有话好好说别乱来啊"><a href="#有话好好说别乱来啊" class="headerlink" title="有话好好说别乱来啊"></a>有话好好说别乱来啊</h2><p>两个数相加，翻倍，输出结果。可以这么写</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OutputDoubleSum</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result = a + b;</span><br><span class="line">  result = result * <span class="number">2</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以这么写</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sum</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Double</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x*<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Output</span>(<span class="params">x</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OutputDoubleSum</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">  Output(Double(Sum(a,b)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还能这么写</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sum</span>(<span class="params">a,b,k</span>)</span>&#123;</span><br><span class="line">  k(a+b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Double</span>(<span class="params">x,k</span>)</span>&#123;</span><br><span class="line">  k(x*<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Output</span>(<span class="params">x,k</span>)</span>&#123;</span><br><span class="line">  k(<span class="built_in">console</span>.log(x));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">OutputDoubleSum</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">  Sum(a,b,<span class="function"><span class="keyword">function</span> (<span class="params">sumxy</span>)</span>&#123;</span><br><span class="line">    Double(sumxy,<span class="function"><span class="keyword">function</span> (<span class="params">doublex</span>)</span>&#123;</span><br><span class="line">      Output(doublex,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一种是顺序风格，第二种是函数组合风格，第三种是后继传递风格。</p>
<p><strong>后继传递风格</strong>（<a href="https://en.wikipedia.org/wiki/Continuation-passing_style" target="_blank" rel="noopener">Continuation-passing style</a>）是一种控制流通过参数传递的风格。</p>
<p>简单的说就是把后继，也就是下一步要运行的代码，封装成函数，通过参数传递的方式传给当前运行的函数。</p>
<p>在例子中 <code>Output(x,k)</code> 的第二个参数接受一个后继，在 <code>Output</code> 执行完成后调用后继。 <code>Output</code> 的后继为</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>是一个空函数，表示后面什么事情都不做。</p>
<p><code>Double</code> 的后继是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">doublex</span>)</span>&#123;</span><br><span class="line">  Output(doublex,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>表示收到 <code>Double</code> 的计算结果后，执行 <code>Output</code> </p>
<p><code>Sum</code> 的后继是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">sumxy</span>)</span>&#123;</span><br><span class="line">  Double(sumxy,<span class="function"><span class="keyword">function</span> (<span class="params">doublex</span>)</span>&#123;</span><br><span class="line">    Output(doublex,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>表示收到 <code>Sum</code> 的计算结果后，执行 <code>Double</code> </p>
<p>这样通过参数传递的方式将顺序风格改为了后继传递风格。</p>
<h2 id="所以有什么用呢"><a href="#所以有什么用呢" class="headerlink" title="所以有什么用呢"></a>所以有什么用呢</h2><p><del>没什么用</del>。当然是有用的啦，不然干嘛这么费力不讨好。</p>
<p>一个最常见的用法是用在异步代码中，也就是<a href="/Promise">异步代码的回调</a>。</p>
<p>搭配 <code>Call/cc</code> 能够实现控制流中的 <code>try/catch</code> 和 <code>yield</code> 等控制方式。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>「CPS 就是把用于经典逻辑和直觉逻辑间命题转换的 Gödel–Gentzen 转换，经 Curry–Howard correspondence 应用到证明过程表示的自然结果。」（逃</p>
</div></article></div></main><footer><div class="paginator"><a href="/Call-with-current-continuation/" class="prev">上一篇</a><a href="/Evaluation-strategy/" class="next">下一篇</a></div><div class="copyright"><p>© 2014 - 2018 <a href="http://en.ors-sro.com">拖鞋党</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p><p>Hosted by <a href="https://pages.coding.me" style="font-weight: bold; animation: breathe 3s infinite">Coding Pages</a></p></div></footer></div><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
    inlineMath: [ ['$','$'], ["\\\(","\\)"] ],
    processEscapes: true
    }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});
</script></body></html>